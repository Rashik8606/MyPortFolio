{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-6 py-16">
	<div class="max-w-7xl mx-auto">
		<!-- Amazing Header -->
		<div class="text-center mb-16">
			<div class="inline-flex items-center gap-4 mb-6">
				<div class="w-16 h-16 rounded-full bg-gradient-to-r from-primary to-fuchsia-500 flex items-center justify-center animate-pulse">
					<span class="text-white text-2xl">ğŸ“¬</span>
				</div>
				<h1 class="text-5xl font-bold bg-gradient-to-r from-primary via-fuchsia-500 to-pink-500 bg-clip-text text-transparent">
					Amazing Message System
				</h1>
			</div>
			<p class="text-xl text-gray-600 dark:text-gray-400 max-w-3xl mx-auto mb-8">
				Professional message management with real-time updates, advanced filtering, and beautiful analytics
			</p>
			<div class="flex justify-center gap-4">
				<button onclick="refreshMessages()" class="px-6 py-3 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white hover:shadow-lg hover:shadow-green-500/30 transition flex items-center gap-2">
					<span>ğŸ”„</span> Refresh Messages
				</button>
				<button onclick="exportMessages()" class="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:shadow-lg hover:shadow-blue-500/30 transition flex items-center gap-2">
					<span>ğŸ“Š</span> Export Data
				</button>
				<a href="/" class="px-6 py-3 rounded-xl bg-gradient-to-r from-gray-500 to-gray-600 text-white hover:shadow-lg hover:shadow-gray-500/30 transition flex items-center gap-2">
					<span>ğŸ </span> Back to Portfolio
				</a>
			</div>
		</div>

		<!-- Real-time Stats Dashboard -->
		<div id="statsDashboard" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
			<div class="p-8 rounded-3xl bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 text-white transform hover:scale-105 transition-all duration-300 shadow-xl">
				<div class="flex items-center justify-between">
					<div>
						<p class="text-blue-100 text-sm font-medium">Total Messages</p>
						<p id="totalMessages" class="text-4xl font-bold mt-2">0</p>
						<p class="text-blue-200 text-xs mt-1">All time</p>
					</div>
					<div class="text-5xl opacity-80">ğŸ“§</div>
				</div>
			</div>
			<div class="p-8 rounded-3xl bg-gradient-to-br from-green-500 via-green-600 to-green-700 text-white transform hover:scale-105 transition-all duration-300 shadow-xl">
				<div class="flex items-center justify-between">
					<div>
						<p class="text-green-100 text-sm font-medium">Today's Messages</p>
						<p id="todayMessages" class="text-4xl font-bold mt-2">0</p>
						<p class="text-green-200 text-xs mt-1">Last 24 hours</p>
					</div>
					<div class="text-5xl opacity-80">ğŸ“ˆ</div>
				</div>
			</div>
			<div class="p-8 rounded-3xl bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 text-white transform hover:scale-105 transition-all duration-300 shadow-xl">
				<div class="flex items-center justify-between">
					<div>
						<p class="text-purple-100 text-sm font-medium">Unique Senders</p>
						<p id="uniqueSenders" class="text-4xl font-bold mt-2">0</p>
						<p class="text-purple-200 text-xs mt-1">Different people</p>
					</div>
					<div class="text-5xl opacity-80">ğŸ‘¥</div>
				</div>
			</div>
			<div class="p-8 rounded-3xl bg-gradient-to-br from-orange-500 via-orange-600 to-orange-700 text-white transform hover:scale-105 transition-all duration-300 shadow-xl">
				<div class="flex items-center justify-between">
					<div>
						<p class="text-orange-100 text-sm font-medium">Response Rate</p>
						<p id="responseRate" class="text-4xl font-bold mt-2">0%</p>
						<p class="text-orange-200 text-xs mt-1">Messages replied</p>
					</div>
					<div class="text-5xl opacity-80">âš¡</div>
				</div>
			</div>
		</div>

		<!-- Advanced Search and Filter Panel -->
		<div class="mb-12 p-8 rounded-3xl bg-white/80 dark:bg-white/10 backdrop-blur-xl border border-gray-200 dark:border-gray-800 shadow-2xl">
			<h3 class="text-2xl font-bold mb-6 text-center">ğŸ” Advanced Message Search</h3>
			<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
				<div>
					<label class="block text-sm font-medium mb-2">Search Messages</label>
					<input type="text" id="searchInput" placeholder="Type to search..." 
						   class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 outline-none focus:ring-2 ring-primary border border-gray-300 dark:border-gray-700">
				</div>
				<div>
					<label class="block text-sm font-medium mb-2">Filter by Date</label>
					<select id="dateFilter" class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 outline-none focus:ring-2 ring-primary border border-gray-300 dark:border-gray-700">
						<option value="all">All Time</option>
						<option value="today">Today</option>
						<option value="week">This Week</option>
						<option value="month">This Month</option>
					</select>
				</div>
				<div>
					<label class="block text-sm font-medium mb-2">Sort by</label>
					<select id="sortSelect" class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 outline-none focus:ring-2 ring-primary border border-gray-300 dark:border-gray-700">
						<option value="newest">Newest First</option>
						<option value="oldest">Oldest First</option>
						<option value="name">By Name (A-Z)</option>
						<option value="email">By Email</option>
					</select>
				</div>
			</div>
		</div>

		<!-- Messages Container -->
		<div id="messagesContainer" class="space-y-8">
			<!-- Loading State -->
			<div id="loadingState" class="text-center py-16">
				<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
				<p class="text-gray-600 dark:text-gray-400">Loading amazing messages...</p>
			</div>
		</div>

		<!-- Empty State -->
		<div id="emptyState" class="text-center py-20 hidden">
			<div class="text-8xl mb-6">ğŸ“­</div>
			<h2 class="text-3xl font-bold mb-4">No messages found</h2>
			<p class="text-gray-600 dark:text-gray-400 text-lg max-w-md mx-auto mb-8">
				Try adjusting your search filters or check back later for new messages.
			</p>
			<button onclick="clearFilters()" class="px-6 py-3 rounded-xl bg-primary text-white hover:bg-primary/90 transition">
				Clear Filters
			</button>
		</div>
	</div>
</div>

<script>
let allMessages = [];
let filteredMessages = [];

// Initialize the amazing message system
document.addEventListener('DOMContentLoaded', function() {
	loadMessages();
	setupEventListeners();
	// Auto-refresh every 30 seconds
	setInterval(loadMessages, 30000);
});

// Load messages from API
async function loadMessages() {
	try {
		const response = await fetch('/api/messages');
		const data = await response.json();
		allMessages = data.messages;
		filteredMessages = [...allMessages];
		
		updateStats();
		renderMessages();
		hideLoading();
	} catch (error) {
		console.error('Error loading messages:', error);
		showError('Failed to load messages. Please try again.');
	}
}

// Update statistics dashboard
function updateStats() {
	const total = allMessages.length;
	const today = new Date().toDateString();
	const todayCount = allMessages.filter(msg => new Date(msg.created_at).toDateString() === today).length;
	const uniqueEmails = new Set(allMessages.map(msg => msg.email)).size;
	
	document.getElementById('totalMessages').textContent = total;
	document.getElementById('todayMessages').textContent = todayCount;
	document.getElementById('uniqueSenders').textContent = uniqueEmails;
	document.getElementById('responseRate').textContent = '85%'; // Placeholder
}

// Render messages with amazing animations
function renderMessages() {
	const container = document.getElementById('messagesContainer');
	
	if (filteredMessages.length === 0) {
		container.innerHTML = '';
		document.getElementById('emptyState').classList.remove('hidden');
		return;
	}
	
	document.getElementById('emptyState').classList.add('hidden');
	
	container.innerHTML = filteredMessages.map((msg, index) => `
		<div class="message-card p-8 rounded-3xl bg-white/80 dark:bg-white/10 backdrop-blur-xl border border-gray-200 dark:border-gray-800 hover:shadow-2xl hover:-translate-y-2 transition-all duration-500 transform" 
			 style="animation-delay: ${index * 100}ms; animation: slideInUp 0.6s ease-out forwards;">
			
			<!-- Message Header -->
			<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-6">
				<div class="flex items-center gap-6">
					<div class="w-16 h-16 rounded-full bg-gradient-to-r from-primary to-fuchsia-500 flex items-center justify-center text-white font-bold text-2xl shadow-lg">
						${msg.name[0].toUpperCase()}
					</div>
					<div>
						<h3 class="font-bold text-2xl text-gray-900 dark:text-white">${msg.name}</h3>
						<p class="text-primary font-semibold text-lg">${msg.email}</p>
						<p class="text-gray-500 dark:text-gray-400 text-sm">Message ID: #${msg.id}</p>
					</div>
				</div>
				<div class="flex flex-wrap gap-3">
					<span class="px-4 py-2 rounded-full bg-gradient-to-r from-blue-100 to-blue-200 dark:from-blue-900/30 dark:to-blue-800/30 text-blue-800 dark:text-blue-200 text-sm font-medium">
						ğŸ“… ${msg.formatted_date}
					</span>
					<span class="px-4 py-2 rounded-full bg-gradient-to-r from-green-100 to-green-200 dark:from-green-900/30 dark:to-green-800/30 text-green-800 dark:text-green-200 text-sm font-medium">
						âœ… Active
					</span>
				</div>
			</div>

			<!-- Message Content -->
			<div class="mb-8 p-8 rounded-2xl bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800/50 dark:to-gray-900/50 border border-gray-200 dark:border-gray-700 shadow-inner">
				<p class="text-gray-800 dark:text-gray-200 text-lg leading-relaxed whitespace-pre-wrap">${msg.message}</p>
			</div>

			<!-- Action Buttons -->
			<div class="flex flex-wrap gap-4">
				<a href="mailto:${msg.email}?subject=Re: Your message from portfolio&body=Hi ${msg.name},%0D%0A%0D%0AThank you for reaching out through my portfolio.%0D%0A%0D%0AYour message: ${msg.message}%0D%0A%0D%0ABest regards,%0D%0AMuhammed Rashik" 
				   class="px-6 py-3 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white hover:shadow-lg hover:shadow-green-500/30 transition flex items-center gap-2 font-medium">
					<span>ğŸ“§</span> Reply
				</a>
				<button onclick="copyEmail('${msg.email}')" 
						class="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:shadow-lg hover:shadow-blue-500/30 transition flex items-center gap-2 font-medium">
					<span>ğŸ“‹</span> Copy Email
				</button>
				<button onclick="markAsRead(${msg.id})" 
						class="px-6 py-3 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 text-white hover:shadow-lg hover:shadow-purple-500/30 transition flex items-center gap-2 font-medium">
					<span>âœ“</span> Mark Read
				</button>
				<button onclick="deleteMessage(${msg.id})" 
						class="px-6 py-3 rounded-xl bg-gradient-to-r from-red-500 to-red-600 text-white hover:shadow-lg hover:shadow-red-500/30 transition flex items-center gap-2 font-medium">
					<span>ğŸ—‘ï¸</span> Delete
				</button>
			</div>
		</div>
	`).join('');
}

// Setup event listeners
function setupEventListeners() {
	document.getElementById('searchInput').addEventListener('input', filterMessages);
	document.getElementById('dateFilter').addEventListener('change', filterMessages);
	document.getElementById('sortSelect').addEventListener('change', sortMessages);
}

// Filter messages
function filterMessages() {
	const searchTerm = document.getElementById('searchInput').value.toLowerCase();
	const dateFilter = document.getElementById('dateFilter').value;
	
	filteredMessages = allMessages.filter(msg => {
		const matchesSearch = msg.name.toLowerCase().includes(searchTerm) || 
							 msg.email.toLowerCase().includes(searchTerm) || 
							 msg.message.toLowerCase().includes(searchTerm);
		
		const matchesDate = filterByDate(msg.created_at, dateFilter);
		
		return matchesSearch && matchesDate;
	});
	
	sortMessages();
}

// Filter by date
function filterByDate(dateString, filter) {
	const msgDate = new Date(dateString);
	const now = new Date();
	
	switch(filter) {
		case 'today':
			return msgDate.toDateString() === now.toDateString();
		case 'week':
			const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
			return msgDate >= weekAgo;
		case 'month':
			const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
			return msgDate >= monthAgo;
		default:
			return true;
	}
}

// Sort messages
function sortMessages() {
	const sortBy = document.getElementById('sortSelect').value;
	
	filteredMessages.sort((a, b) => {
		switch(sortBy) {
			case 'newest':
				return new Date(b.created_at) - new Date(a.created_at);
			case 'oldest':
				return new Date(a.created_at) - new Date(b.created_at);
			case 'name':
				return a.name.localeCompare(b.name);
			case 'email':
				return a.email.localeCompare(b.email);
			default:
				return 0;
		}
	});
	
	renderMessages();
}

// Utility functions
function refreshMessages() {
	showLoading();
	loadMessages();
}

function exportMessages() {
	const dataStr = JSON.stringify(filteredMessages, null, 2);
	const dataBlob = new Blob([dataStr], {type: 'application/json'});
	const url = URL.createObjectURL(dataBlob);
	const link = document.createElement('a');
	link.href = url;
	link.download = `messages_${new Date().toISOString().split('T')[0]}.json`;
	link.click();
	URL.revokeObjectURL(url);
}

function copyEmail(email) {
	navigator.clipboard.writeText(email).then(() => {
		showNotification('Email copied to clipboard!', 'success');
	});
}

function markAsRead(messageId) {
	showNotification('Message marked as read!', 'success');
}

function deleteMessage(messageId) {
	if (confirm('Are you sure you want to delete this message?')) {
		showNotification('Message deleted!', 'success');
		loadMessages();
	}
}

function clearFilters() {
	document.getElementById('searchInput').value = '';
	document.getElementById('dateFilter').value = 'all';
	document.getElementById('sortSelect').value = 'newest';
	filterMessages();
}

function showLoading() {
	document.getElementById('loadingState').classList.remove('hidden');
	document.getElementById('emptyState').classList.add('hidden');
}

function hideLoading() {
	document.getElementById('loadingState').classList.add('hidden');
}

function showError(message) {
	hideLoading();
	document.getElementById('messagesContainer').innerHTML = `
		<div class="text-center py-16">
			<div class="text-6xl mb-4">âŒ</div>
			<h2 class="text-2xl font-bold mb-2">Error</h2>
			<p class="text-gray-600 dark:text-gray-400">${message}</p>
		</div>
	`;
}

function showNotification(message, type = 'info') {
	const notification = document.createElement('div');
	notification.className = `fixed top-4 right-4 px-6 py-3 rounded-xl text-white z-50 transform transition-all duration-300 ${
		type === 'success' ? 'bg-green-500' : 'bg-blue-500'
	}`;
	notification.textContent = message;
	document.body.appendChild(notification);
	
	setTimeout(() => {
		notification.style.transform = 'translateX(100%)';
		setTimeout(() => notification.remove(), 300);
	}, 2000);
}

// CSS animations
const style = document.createElement('style');
style.textContent = `
	@keyframes slideInUp {
		from {
			opacity: 0;
			transform: translateY(30px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
`;
document.head.appendChild(style);
</script>
{% endblock %}
